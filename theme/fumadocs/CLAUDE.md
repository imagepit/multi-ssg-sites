# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is a **Fumadocs-based documentation site** built with Next.js 15. The project supports **multi-site architecture** where a single codebase can serve multiple documentation sites by switching content sources via the `SITE_ID` environment variable.

## Development Commands

```bash
# Development (includes prebuild scripts)
pnpm dev

# Production build (includes prebuild scripts for search index, images, etc.)
pnpm build

# Start production server
pnpm start

# Linting
pnpm lint
```

### Build Process

The build pipeline (`prebuild` script) runs these steps automatically:

1. **manage-api-route.mjs** - Switches between SSR and SSG API routes
2. **collect-images.mjs** - Collects images from content directories
3. **prepare-site-assets.mjs** - Prepares site-specific branding assets
4. **generate-search-index.mjs** - Generates Orama search index for static search

## Architecture

### Multi-Site System

The codebase supports multiple documentation sites through environment-based content switching:

- **SITE_ID / NEXT_PUBLIC_SITE_ID**: Determines which site to build
- Content location: `../../contents/${SITE_ID}/contents/` (when SITE_ID is set)
- Site config: `../../contents/${SITE_ID}/specs/spec.json`
- Sitemap structure: `../../contents/${SITE_ID}/specs/sitemap.md`

Key files:
- [source.config.ts](source.config.ts) - Controls content directory based on SITE_ID
- [src/lib/source.ts](src/lib/source.ts) - Loads Fumadocs content and builds sidebar from `sitemap.md`
- [src/lib/site-config.ts](src/lib/site-config.ts) - Reads site-specific configuration (theme, branding, metadata)

### Content Pipeline

1. **Source Configuration** ([source.config.ts](source.config.ts))
   - Defines which directory to load MDX files from
   - Configures custom remark/rehype plugins for content processing
   - Excludes files: `README.md`, `AGENTS.md`, `CLAUDE.md`

2. **Custom MDX Plugins** (in [src/lib/](src/lib/))
   - `remark-files-to-mdx` - Converts file tree syntax to MDX
   - `remark-steps` - Step-by-step tutorial blocks
   - `remark-code-title` - Code block titles
   - `remark-admonition-blocks` - Callout/admonition blocks
   - `remark-adddel` - Add/delete diff regions
   - `rehype-resolve-images` - Resolves image paths
   - `rehype-next-image` - Converts img tags to Next.js Image components
   - `shiki-raw-notation` - Syntax highlighting with raw notation support

3. **Sidebar Generation** ([src/lib/source.ts](src/lib/source.ts))
   - Parses `specs/sitemap.md` to build sidebar tree
   - Falls back to auto-generated tree if sitemap not found
   - Supports nested folders and index pages

### Search System

Two modes controlled by `NEXT_PUBLIC_SEARCH_STATIC`:

1. **SSR Search (default)**: Uses `/api/search` endpoint
2. **SSG Search (SSG_EXPORT=1)**: Uses pregenerated Orama index
   - Index location: `public/search-indexes/${SITE_ID}.json`
   - Generated by [scripts/generate-search-index.mjs](scripts/generate-search-index.mjs)
   - Supports Japanese tokenization via `Intl.Segmenter`
   - Indexes both page-level and heading-level content (h2, h3)

Search component: [src/components/CustomStaticSearchDialog.tsx](src/components/CustomStaticSearchDialog.tsx)

### Theme System

Site-specific theming via `specs/spec.json`:

```json
{
  "theme_config": {
    "colors": {
      "primary": "#hex-color"
    },
    "branding": {
      "logo": "logo.svg",
      "favicon": "favicon.ico",
      "og_image": "og.png"
    }
  }
}
```

Theme is applied via [src/lib/theme-derive.ts](src/lib/theme-derive.ts) which generates CSS variables dynamically.

### Export Mode

Build for static export:

```bash
SSG_EXPORT=1 pnpm build
```

This enables:
- `output: 'export'` in Next.js config
- Static search index generation
- Image optimization via `next-image-export-optimizer`
- Disables SSR API routes

## Important Patterns

### Path Aliases

- `@/*` - Points to `src/*`
- `@/.source` - Points to `.source/index.ts` (generated by fumadocs-mdx)

### Image Handling

Images use custom loader ([src/image-loader.ts](src/image-loader.ts)) with `next-image-export-optimizer`:
- Supports WebP and AVIF
- Generates blur placeholders
- Works with static export mode

#### Global Images Policy (per-site SSG)

- Workspace-level `images/` is the single, shared image pool across all sites.
- Content may reference any path under `/images/**` regardless of site ID.
- During build, `scripts/collect-images.mjs` scans the target site's MD/MDX and
  writes a manifest of only the images actually referenced.
- `scripts/prepare-site-assets.mjs` then copies just those files into this app's
  `public/images/**` for the site build, ensuring per-site deployments only ship
  what is needed.
- Fallback (when the manifest is missing) copies the entire workspace `images/` to
  `public/images/` to avoid broken references in development.

### Content Structure

Expected content directory structure:
```
contents/${SITE_ID}/
├── specs/
│   ├── spec.json       # Site config
│   └── sitemap.md      # Sidebar structure
└── contents/           # MDX files
    ├── index.mdx
    └── ...
```

### Memory Optimization

Build uses memory optimization settings in [next.config.mjs](next.config.mjs):
- `NODE_OPTIONS='--max-old-space-size=4096'` for builds
- Memory-based worker count
- Code splitting for vendor chunks

## Common Tasks

### Adding a Custom Remark/Rehype Plugin

1. Create plugin in `src/lib/remark-*.ts` or `src/lib/rehype-*.ts`
2. Add to [source.config.ts](source.config.ts) in `remarkPlugins` or `rehypePlugins` array
3. Order matters: remark runs before rehype

### Customizing Search Index

Modify [scripts/generate-search-index.mjs](scripts/generate-search-index.mjs):
- Adjust `extractTextFromMarkdown()` for content extraction
- Modify `extractHeadings()` to change heading indexing rules
- Update Orama schema if adding new fields

### Adding Site-Specific Assets

Assets go to `public/sites/${SITE_ID}/`:
- Automatically prepared by `scripts/prepare-site-assets.mjs`
- Accessed via `/brand/${filename}` routes

### Debugging Build Issues

Check prebuild script logs:
```bash
# Run individual prebuild steps
node scripts/manage-api-route.mjs
node scripts/collect-images.mjs
node scripts/prepare-site-assets.mjs
SITE_ID=mysite node scripts/generate-search-index.mjs
```
