name: Sync Admin Metadata

on:
  workflow_dispatch:
    inputs:
      site_id:
        description: "site-id to sync"
        required: false
        type: string
  push:
    paths:
      - "contents/**"
      - "scripts/sync-pages.mjs"
      - ".github/workflows/sync.yml"

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      sites: ${{ steps.detect.outputs.sites }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed sites
        id: detect
        run: |
          if [ -n "${{ github.event.inputs.site_id }}" ]; then
            echo "sites=[\"${{ github.event.inputs.site_id }}\"]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BEFORE="${{ github.event.before }}"
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            RANGE="HEAD~1"
          else
            RANGE="$BEFORE...${{ github.sha }}"
          fi

          sites=$(git diff --name-only "$RANGE" \
            | awk -F/ '/^contents\/[^/]+\// {print $2}' \
            | sort -u \
            | jq -R -s -c 'split("\n") | map(select(length>0))')

          echo "sites=$sites" >> "$GITHUB_OUTPUT"

  sync:
    needs: detect
    if: ${{ needs.detect.outputs.sites != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        site: ${{ fromJson(needs.detect.outputs.sites) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Sync pages
        env:
          ADMIN_APP_BASE_URL: ${{ secrets.ADMIN_APP_BASE_URL }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
          SITE_DOMAIN: ${{ secrets.SITE_DOMAIN }}
          THEME_ID: ${{ secrets.THEME_ID }}
        run: node scripts/sync-pages.mjs --site-id ${{ matrix.site }}
